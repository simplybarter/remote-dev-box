FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive
ENV TIMEZONE=UTC

# Setup timezone
RUN ln -snf /usr/share/zoneinfo/$TIMEZONE /etc/localtime && echo $TIMEZONE > /etc/timezone

# Install core packages and desktop environment
RUN apt-get update && apt-get install -y --no-install-recommends \
  xfce4 \
  xfce4-panel \
  xfce4-session \
  xfce4-settings \
  xfdesktop4 \
  xfwm4 \
  xfconf \
  xfce4-terminal \
  xfce4-screenshooter \
  gvfs gvfs-backends \
  xrdp xorgxrdp \
  sudo \
  git curl wget ca-certificates openssh-client \
  vim nano htop jq ripgrep tmux zsh fzf \
  tree \
  iputils-ping iproute2 \
  sqlite3 postgresql-client redis-tools \
  unzip zip p7zip-full \
  lsof \
  locales \
  python3 python3-pip python3-venv\
  # pipx \
  gnupg \
  openssl \
  xauth x11-xserver-utils \
  tigervnc-standalone-server \
  dbus dbus-x11 dbus-system-bus-common \
  at-spi2-core tumbler \
  adwaita-icon-theme shared-mime-info \
  xcursor-themes dmz-cursor-theme \
  autocutsel \
  librsvg2-common \
  mesa-utils libgl1-mesa-dri \
  libstdc++6 \
  && apt-get purge -y samba-libs udev udisks2 unminimize cryptsetup-bin dmsetup \
  && apt-get autoremove -y \
  && apt-get clean && rm -rf /var/lib/apt/lists/*

# Generate locales
RUN locale-gen en_US.UTF-8
ENV LANG=en_US.UTF-8 \
  LANGUAGE=en_US:en \
  LC_ALL=en_US.UTF-8

# Install Node.js, Gemini, Codex, OpenCode, Copilot in consolidated layers to save space
RUN curl -fsSL https://deb.nodesource.com/setup_22.x | bash - \
  && apt-get install -y --no-install-recommends nodejs \
  && npm install -g npm@latest pnpm@latest \
  && npm install -g @google/gemini-cli@latest @openai/codex@latest opencode-ai@latest @github/copilot@latest \
  && find /usr/lib/node_modules -type d \( -name "*win32*" -o -name "*darwin*" -o -name "*arm64*" -o -name "*aarch64*" \) -exec rm -rf {} + \
  && npm cache clean --force \
  && apt-get clean && rm -rf /var/lib/apt/lists/*

# Install Claude Code globally
RUN curl -fsSL https://claude.ai/install.sh | bash \
  && mv /root/.local/share/claude /usr/share/claude \
  && ln -s /usr/share/claude/versions/$(ls /usr/share/claude/versions | head -n 1) /usr/local/bin/claude

# Install Antigravity, Google Chrome, Cursor via official repositories
RUN mkdir -p /etc/apt/keyrings \
  && curl -fsSL https://us-central1-apt.pkg.dev/doc/repo-signing-key.gpg | gpg --dearmor --yes -o /etc/apt/keyrings/antigravity-repo-key.gpg \
  && echo "deb [signed-by=/etc/apt/keyrings/antigravity-repo-key.gpg] https://us-central1-apt.pkg.dev/projects/antigravity-auto-updater-dev/ antigravity-debian main" > /etc/apt/sources.list.d/antigravity.list \
  && curl -fsSL https://downloads.cursor.com/keys/anysphere.asc | gpg --dearmor --yes -o /etc/apt/keyrings/cursor.gpg \
  && echo "deb [arch=amd64,arm64 signed-by=/etc/apt/keyrings/cursor.gpg] https://downloads.cursor.com/aptrepo stable main" > /etc/apt/sources.list.d/cursor.list \
  && curl -fsSL https://dl.google.com/linux/linux_signing_key.pub | gpg --dearmor --yes -o /etc/apt/keyrings/google-chrome.gpg \
  && echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list \
  && apt-get update && apt-get install -y --no-install-recommends antigravity cursor google-chrome-stable \
  && find /usr/share/antigravity/locales -type f ! -name "en-US.pak" -delete \
  && find /usr/share/antigravity/resources/app/extensions -type d \( -name "markdown-math" -o -name "php-language-features" \) -exec rm -rf {} + \
  && apt-get clean && rm -rf /var/lib/apt/lists/*

# Setup XRDP
RUN adduser xrdp ssl-cert \
  && sed -i 's/max_bpp=32/max_bpp=24/g' /etc/xrdp/xrdp.ini \
  && sed -i 's/new_cursors=true/new_cursors=false/g' /etc/xrdp/xrdp.ini \
  # Ensure Xvnc is the default and configured correctly
  && sed -i '/\[Xorg\]/,/\[Xvnc\]/ { /\[Xvnc\]/! d }' /etc/xrdp/xrdp.ini \
  && sed -i 's/\[Xvnc\]/\[Xvnc\]\nname=Xvnc\nlib=libvnc.so\nusername=ask\npassword=ask\nip=127.0.0.1\nport=-1\n/' /etc/xrdp/xrdp.ini

# Configure sesman for Xvnc (Ubuntu default is Xorg)
RUN sed -i 's/DefaultWindowManager=startwm.sh/DefaultWindowManager=\/etc\/xrdp\/startwm.sh/g' /etc/xrdp/sesman.ini \
  && sed -i 's/UserWindowManager=startwm.sh/UserWindowManager=\/etc\/xrdp\/startwm.sh/g' /etc/xrdp/sesman.ini

# Create startwm.sh for XFCE4 environment
RUN printf '%s\n' \
  '#!/bin/sh' \
  'if [ -r /etc/default/locale ]; then' \
  '  . /etc/default/locale' \
  '  export LANG LANGUAGE' \
  'fi' \
  'export XDG_SESSION_TYPE=x11' \
  'export XDG_CURRENT_DESKTOP=XFCE' \
  'export XDG_CONFIG_DIRS=/etc/xdg:/etc/X11/xinit/xinitrc.d' \
  'exec > $HOME/xrdp.log 2>&1' \
  'unset DBUS_SESSION_BUS_ADDRESS' \
  'unset XDG_RUNTIME_DIR' \
  'export XDG_RUNTIME_DIR="/tmp/runtime-$USER"' \
  'mkdir -p "$XDG_RUNTIME_DIR"' \
  'chmod 700 "$XDG_RUNTIME_DIR"' \
  '# Start autocutsel for clipboard sync' \
  'autocutsel -fork -selection PRIMARY' \
  'autocutsel -fork -selection CLIPBOARD' \
  'vncconfig -nowin &' \
  'exec dbus-run-session -- startxfce4' \
  > /etc/xrdp/startwm.sh \
  && chmod +x /etc/xrdp/startwm.sh

# Wallpaper script
COPY assets/background.png /usr/share/backgrounds/xfce/remote-dev-bg.png

RUN printf '%s\n' \
  '#!/bin/sh' \
  'sleep 5' \
  'for monitor in monitor0 monitorVNC-0; do' \
  '  for workspace in workspace0 workspace1 workspace2 workspace3; do' \
  '    xfconf-query -c xfce4-desktop -p "/backdrop/screen0/$monitor/$workspace/last-image" -n -t string -s /usr/share/backgrounds/xfce/remote-dev-bg.png' \
  '    xfconf-query -c xfce4-desktop -p "/backdrop/screen0/$monitor/$workspace/image-style" -n -t int -s 5' \
  '  done' \
  'done' \
  > /usr/local/bin/set-wallpaper.sh \
  && chmod +x /usr/local/bin/set-wallpaper.sh

# Autostart wallpaper
RUN mkdir -p /etc/xdg/autostart \
  && printf '%s\n' \
  '[Desktop Entry]' \
  'Type=Application' \
  'Name=Set Wallpaper' \
  'Exec=/usr/local/bin/set-wallpaper.sh' \
  'Hidden=false' \
  'NoDisplay=false' \
  'X-GNOME-Autostart-enabled=true' \
  > /etc/xdg/autostart/set-wallpaper.desktop

# uv via pipx
# ENV PIPX_HOME=/opt/pipx
# ENV PIPX_BIN_DIR=/usr/local/bin
# RUN mkdir -p "$PIPX_HOME" "$PIPX_BIN_DIR" \
#   && pipx install uv \
#   && uv --version

# Copy entrypoint
COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

EXPOSE 3400
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
